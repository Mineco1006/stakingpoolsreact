{"ast":null,"code":"import Web3 from 'web3';\nimport axios from 'axios';\n\nasync function generateTx(to, data, value, from = null) {\n  if (from === null) {\n    from = this.address;\n  }\n\n  const transactionCountResp = await axios.post(\"/getTransactionCount\", {\n    address: from\n  });\n  const fromFullShardKey = \"0x\" + from.slice(-8);\n  let toRecipient;\n  let toFullShardKey;\n\n  if (to !== \"\") {\n    toRecipient = to.slice(0, 42);\n    toFullShardKey = \"0x\" + to.slice(42);\n  } else {\n    toRecipient = \"\";\n    toFullShardKey = fromFullShardKey;\n  }\n\n  const rawTx = {\n    nonce: transactionCountResp.data.transactionCount,\n    from: from.slice(0, 42),\n    to: toRecipient,\n    gasPrice: \"0x\" + 2 .toString(16),\n    gas: \"0x\" + 350000 .toString(16),\n    value: \"0x\" + value.toString(16),\n    data,\n    fromFullShardKey,\n    toFullShardKey,\n    networkId: `0x${1 .toString(16)}`,\n    gasTokenId: `0x${this.gasTokenId.toString(16)}`,\n    transferTokenId: `0x${this.transferTokenId.toString(16)}`\n  };\n}\n\nasync function signAndSendTx(rawTx) {\n  let txId = '';\n\n  try {\n    txId = await this.qPocketSignAndSendTx(rawTx);\n  } catch (error) {\n    console.log(\"error 404\");\n    return;\n  }\n\n  txId = txId;\n  const success = !!txId && !txId.startsWith('0x000000000000000000000000000000000000000');\n\n  if (success) {\n    //const url = (<a href=\"/tx/${txId}\">${txId}</a>);\n    console.log(`Successfully sent transaction ${txId}.`);\n  } else {\n    console.log(\"Sending transaction failed\", 7000);\n  }\n}\n\nfunction metaMaskSignTyped(tx, web3, from) {\n  console.log(\"Awaiting MetaMask signature confirmation...\");\n  return new Promise(function (resolve, reject) {\n    var params = [from, getTypedTx(tx)];\n    var method = 'eth_signTypedData_v3';\n    web3.currentProvider.send({\n      method,\n      params,\n      from\n    }, function (err, result) {\n      if (result.error !== undefined) {\n        console.log(\"It looks you declined the transaction in MetaMask\");\n        console.log(result.error);\n      }\n\n      console.log(result.result);\n    });\n  }.bind(this));\n}\n\nfunction getDeviceType() {\n  var ua = navigator.userAgent,\n      isWindowsPhone = /(?:Windows Phone)/.test(ua),\n      isSymbian = /(?:SymbianOS)/.test(ua) || isWindowsPhone,\n      isAndroid = /(?:Android)/.test(ua),\n      isFireFox = /(?:Firefox)/.test(ua),\n      isChrome = /(?:Chrome|CriOS)/.test(ua),\n      isTablet = /(?:iPad|PlayBook)/.test(ua) || isAndroid && !/(?:Mobile)/.test(ua) || isFireFox && /(?:Tablet)/.test(ua),\n      isPhone = /(?:iPhone)/.test(ua) && !isTablet,\n      isPc = !isPhone && !isAndroid && !isSymbian;\n  return {\n    isPhone,\n    isPc\n  };\n}\n\nfunction getTypedTx(tx) {\n  let msgParams = [{\n    name: 'nonce',\n    type: 'uint256',\n    value: `0x${tx.nonce.toString(16)}`\n  }, {\n    name: 'gasPrice',\n    type: 'uint256',\n    value: `0x${tx.gasPrice.toString(16)}`\n  }, {\n    name: 'gasLimit',\n    type: 'uint256',\n    value: `0x${tx.gasLimit.toString(16)}`\n  }, {\n    name: 'to',\n    type: 'uint160',\n    value: `${tx.to}`\n  }, {\n    name: 'value',\n    type: 'uint256',\n    value: `0x${tx.value.toString(16)}`\n  }, {\n    name: 'data',\n    type: 'bytes',\n    value: `0x${tx.data.toString(16)}`\n  }, {\n    name: 'networkId',\n    type: 'uint256',\n    value: '0x1'\n  }, {\n    name: 'fromFullShardKey',\n    type: 'uint32',\n    value: `0x${tx.fromFullShardKey.toString(16)}`\n  }, {\n    name: 'toFullShardKey',\n    type: 'uint32',\n    value: `0x${tx.toFullShardKey.toString(16)}`\n  }, {\n    name: 'gasTokenId',\n    type: 'uint64',\n    value: '0x8bb0'\n  }, {\n    name: 'transferTokenId',\n    type: 'uint64',\n    value: '0x8bb0'\n  }, {\n    name: 'qkcDomain',\n    type: 'string',\n    value: 'bottom-quark'\n  }];\n  console.log(msgParams);\n  console.log(msgParams.data);\n  return msgParams;\n}\n\nexport { metaMaskSignTyped, getTypedTx, getDeviceType };","map":{"version":3,"sources":["C:/Users/Nico/Documents/GitHub/quarkchainposwapp/app/src/functionCol/lib.js"],"names":["Web3","axios","generateTx","to","data","value","from","address","transactionCountResp","post","fromFullShardKey","slice","toRecipient","toFullShardKey","rawTx","nonce","transactionCount","gasPrice","toString","gas","networkId","gasTokenId","transferTokenId","signAndSendTx","txId","qPocketSignAndSendTx","error","console","log","success","startsWith","metaMaskSignTyped","tx","web3","Promise","resolve","reject","params","getTypedTx","method","currentProvider","send","err","result","undefined","bind","getDeviceType","ua","navigator","userAgent","isWindowsPhone","test","isSymbian","isAndroid","isFireFox","isChrome","isTablet","isPhone","isPc","msgParams","name","type","gasLimit"],"mappings":"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","sourcesContent":["import Web3 from 'web3'\r\nimport axios from 'axios'\r\n\r\nasync function generateTx(to, data, value, from = null) {\r\n    if (from === null) {\r\n      from = this.address;\r\n    }\r\n    const transactionCountResp = await axios.post(\r\n      \"/getTransactionCount\",\r\n      { address: from },\r\n    );\r\n    const fromFullShardKey = \"0x\" + from.slice(-8);\r\n    let toRecipient;\r\n    let toFullShardKey;\r\n    if (to !== \"\") {\r\n      toRecipient = to.slice(0, 42);\r\n      toFullShardKey = \"0x\" + to.slice(42);\r\n    } else {\r\n      toRecipient = \"\";\r\n      toFullShardKey = fromFullShardKey;\r\n    }\r\n    const rawTx = {\r\n      nonce: transactionCountResp.data.transactionCount,\r\n      from: from.slice(0, 42),\r\n      to: toRecipient,\r\n      gasPrice: \"0x\" + (2).toString(16),\r\n      gas: \"0x\" + (350000).toString(16),\r\n      value: \"0x\" + value.toString(16),\r\n      data,\r\n      fromFullShardKey,\r\n      toFullShardKey,\r\n      networkId: `0x${(1).toString(16)}`,\r\n      gasTokenId: `0x${this.gasTokenId.toString(16)}`,\r\n      transferTokenId: `0x${this.transferTokenId.toString(16)}`,\r\n    }\r\n\r\n}\r\n\r\nasync function signAndSendTx(rawTx){\r\n    let txId = '';\r\n    try {\r\n        txId = await this.qPocketSignAndSendTx(rawTx);\r\n    } catch (error) {\r\n        console.log(\"error 404\")\r\n        return;\r\n    }\r\n\r\n    txId = txId;\r\n\r\n    const success = !!txId && !txId.startsWith('0x000000000000000000000000000000000000000');\r\n    if (success) {\r\n        //const url = (<a href=\"/tx/${txId}\">${txId}</a>);\r\n        console.log(`Successfully sent transaction ${txId}.`);\r\n        \r\n    } else {\r\n        console.log(\"Sending transaction failed\", 7000);\r\n    }\r\n}\r\n\r\nfunction metaMaskSignTyped(tx, web3, from) {\r\n    console.log(\"Awaiting MetaMask signature confirmation...\");\r\n    return new Promise(function(resolve,reject) {\r\n        var params = [from, getTypedTx(tx)];\r\n        var method = 'eth_signTypedData_v3';\r\n\r\n        web3.currentProvider.send({\r\n          method,\r\n          params,\r\n          from,\r\n        }, function (err, result) {\r\n          if(result.error !== undefined) {\r\n            console.log(\"It looks you declined the transaction in MetaMask\");\r\n            console.log(result.error);\r\n          }\r\n          console.log(result.result);\r\n        })\r\n    }.bind(this));\r\n  }\r\n\r\nfunction getDeviceType() {\r\n  var ua = navigator.userAgent,\r\n          isWindowsPhone = /(?:Windows Phone)/.test(ua),\r\n          isSymbian = /(?:SymbianOS)/.test(ua) || isWindowsPhone,\r\n          isAndroid = /(?:Android)/.test(ua),\r\n          isFireFox = /(?:Firefox)/.test(ua),\r\n          isChrome = /(?:Chrome|CriOS)/.test(ua),\r\n          isTablet = /(?:iPad|PlayBook)/.test(ua) || (isAndroid && !/(?:Mobile)/.test(ua)) || (isFireFox && /(?:Tablet)/.test(ua)),\r\n          isPhone = /(?:iPhone)/.test(ua) && !isTablet,\r\n          isPc = !isPhone && !isAndroid && !isSymbian;\r\n  return {\r\n    isPhone,\r\n    isPc\r\n  }\r\n}\r\n\r\nfunction getTypedTx(tx) {\r\n\r\n  let msgParams = [\r\n    {\r\n      name: 'nonce',\r\n      type: 'uint256',\r\n      value: `0x${tx.nonce.toString(16)}`\r\n    },\r\n    {\r\n      name: 'gasPrice',\r\n      type: 'uint256',\r\n      value: `0x${tx.gasPrice.toString(16)}`\r\n    },\r\n    {\r\n      name: 'gasLimit',\r\n      type: 'uint256',\r\n      value: `0x${tx.gasLimit.toString(16)}`\r\n    },\r\n    {\r\n      name: 'to',\r\n      type: 'uint160',\r\n      value: `${tx.to}`\r\n    },\r\n    {\r\n      name: 'value',\r\n      type: 'uint256',\r\n      value: `0x${tx.value.toString(16)}`\r\n    },\r\n    {\r\n      name: 'data',\r\n      type: 'bytes',\r\n      value: `0x${tx.data.toString(16)}`\r\n    },\r\n    {\r\n      name: 'networkId',\r\n      type: 'uint256',\r\n      value: '0x1'\r\n    },\r\n    {\r\n      name: 'fromFullShardKey',\r\n      type: 'uint32',\r\n      value: `0x${tx.fromFullShardKey.toString(16)}`\r\n    },\r\n    {\r\n      name: 'toFullShardKey',\r\n      type: 'uint32',\r\n      value: `0x${tx.toFullShardKey.toString(16)}`\r\n    },\r\n    {\r\n      name: 'gasTokenId',\r\n      type: 'uint64',\r\n      value: '0x8bb0'\r\n    },\r\n    {\r\n      name: 'transferTokenId',\r\n      type: 'uint64',\r\n      value: '0x8bb0'\r\n    },\r\n    {\r\n      name: 'qkcDomain',\r\n      type: 'string',\r\n      value: 'bottom-quark'\r\n    }\r\n  ];\r\n  console.log(msgParams)\r\n  console.log(msgParams.data)\r\n  return msgParams;\r\n}\r\n\r\nexport {metaMaskSignTyped, getTypedTx, getDeviceType};"]},"metadata":{},"sourceType":"module"}